#include "FelisUSB.h"
#include "classes/FelisUsbDClassHID.h"
#include "desc.h"

extern fusbd_device_t gUsbDev;

uint8_t HidBuf[64];

static int OnHidReceived(fusbd_hid_pt pHid, void * pBuf)
{
	fusbd_class_send_data_async(pHid, &fusbd_hid_rt(pHid)->vEpIn, HidBuf, sizeof(HidBuf));
	return 0;
}

const fusbd_hid_t gHidClass = FUSBD_HID_CLASS(
	&gUsbDev,
	HidReportDescriptor, 
	FUSBD_HID_CLASS_RUNTIME(HidBuf),
	.OnReceived = OnHidReceived
);

const uint8_t DemoFrames[2][2][514] = {
	{
		{
			0x02, 0x00,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80
		},
		{
			0x02, 0x02,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80
		}
	},
	{
		{
			0x02, 0x01,
			0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80
		},
		{
			0x02, 0x03,
			0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,
			0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80,0xFF,0x80,0x00,0x80
		}
	}
};

uint8_t nFrameLoop;
uint8_t nFrameStep;

int OnUvcSent(fusbd_uvc_pt pUVC)
{
	const uint8_t *pData;
	
	uint8_t nLevel = (fusbd_uvc_rt(pUVC)->vProbe.bFrameIndex == 1) ? 96 : 192;
	
	if (nLevel == (++nFrameLoop))
	{
		pData = DemoFrames[nFrameStep][1];
		nFrameLoop = 0;
		nFrameStep ^= 1;
	}
	else
	{
		pData = DemoFrames[nFrameStep][0];
	}
	
	fusbd_class_send_data_async(pUVC, &fusbd_uvc_rt(pUVC)->vEpVS, pData, 514);
	return 0;
}

int OnUvcSelect(fusbd_uvc_pt pUVC, uint8_t nSelect)
{
	nFrameLoop = 0;
	nFrameStep = 0;
	if (0 != nSelect)
	{
		OnUvcSent(pUVC);
	}
	return 0;
}

const fusbd_uvc_t gUvcClass = FUSBD_UVC_CLASS(
	&gUsbDev,
	FUSBD_UVC_CLASS_RUNTIME(),
	.OnSelect = OnUvcSelect,
	.OnSent = OnUvcSent
);

fusbd_device_t gUsbDev = FUSBD_DEVICE(
	&FUSBD_DEVICE_CONFIG(
		&FUsbDeviceDescriptors,
		(fusbd_class_pt)&gUvcClass,
		(fusbd_class_pt)&gHidClass
	)
);

__USED void StartUSB()
{
	fusbd_device_init(&gUsbDev);
	fusbd_device_start(&gUsbDev);
	fusbd_device_check_configed(&gUsbDev, FUSBD_TIMEOUT_INFINITY);
}

